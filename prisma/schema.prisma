generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String    @id @default(cuid())
  name         String
  lastName     String?   // NUEVO: apellido
  rut          String?   // NUEVO: RUT (puede ser null al inicio)
  email        String    @unique
  passwordHash String?
  phone        String?
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(6)
  addresses    Address[]
  orders       Order[]
}

model Address {
  id        String     @id @default(cuid())
  userId    String?    // invitado OK
  fullName  String
  phone     String
  street    String
  number    String?
  apartment String?
  city      String
  region    String
  country   String     @default("Chile")
  isDefault Boolean    @default(false)
  commune   String?
  user      User?      @relation(fields: [userId], references: [id])
  shipments Shipment[]
}

model Product {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  price       Int

  priceCard     Int   @default(0)
  priceTransfer Int   @default(0)

  imageUrl    String?
  stock       Int?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(6)
  orderItems  OrderItem[]
}

model Order {
  id             String         @id @default(cuid())
  userId         String?
  contactEmail   String
  contactName    String
  contactPhone   String?
  status         OrderStatus    @default(PENDING_PAYMENT)
  shippingMethod ShippingMethod
  paymentMethod  PaymentMethod
  shippingCost   Int            @default(0)
  subtotal       Int
  total          Int
  notes          String?
  createdAt      DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime       @updatedAt @db.Timestamptz(6)

  checkoutToken           String?   @unique
  confirmationEmailSentAt DateTime? @db.Timestamptz(6)

  user           User?          @relation(fields: [userId], references: [id])
  items          OrderItem[]
  payment        Payment?
  shipment       Shipment?
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  productName String
  unitPrice   Int
  quantity    Int
  order       Order   @relation(fields: [orderId], references: [id])
  product     Product @relation(fields: [productId], references: [id])
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  amount        Int
  transactionId String?
  proofUrl      String?
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  order         Order         @relation(fields: [orderId], references: [id])
}

model Shipment {
  id             String         @id @default(cuid())
  orderId        String         @unique
  type           ShippingMethod
  addressId      String?
  pickupLocation String?
  status         ShipmentStatus @default(PENDING)
  trackingCode   String?
  estimatedDate  DateTime?      @db.Timestamptz(6)
  createdAt      DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime       @updatedAt @db.Timestamptz(6)
  address        Address?       @relation(fields: [addressId], references: [id])
  order          Order          @relation(fields: [orderId], references: [id])
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PREPARING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
}

enum ShippingMethod {
  DELIVERY
  PICKUP
}

enum PaymentMethod {
  CARD
  TRANSFER
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum ShipmentStatus {
  PENDING
  READY
  ON_ROUTE
  DELIVERED
}
